# Cети в Kubernetes

Представьте, что у вас есть большой офис с множеством рабочих мест (контейнеры), где сотрудники (поды) работают над разными задачами. Чтобы сотрудники могли общаться друг с другом, обмениваться файлами и сообщениями, нужны дороги, почта или интернет. В Kubernetes сети — это "дороги", которые соединяют контейнеры внутри кластера, чтобы они могли общаться, передавать данные и работать как единое целое.

Kubernetes сам по себе не создаёт сети — он использует специальные инструменты, называемые CNI (Container Network Interface), чтобы настроить эти "дороги". Кроме того, есть дополнительные инструменты (например, Service Mesh или Network Policies), которые помогают управлять трафиком, защищать соединения и следить за тем, чтобы всё работало безопасно и эффективно.

## 1. CNI (Container Network Interface) — Основы сетей в Kubernetes

CNI — это стандарт, который Kubernetes использует для настройки сетей между контейнерами (подами). Это как набор правил и инструментов, которые позволяют подам "разговаривать" друг с другом через сеть. Kubernetes сам не знает, как именно строить сети, поэтому он доверяет эту задачу специальным плагинам (программам), которые называются CNI-плагинами.

### Что делают CNI-плагины?
- Создают сеть, чтобы каждый под (контейнер) мог получить уникальный IP-адрес.
- Обеспечивают, чтобы поды могли общаться друг с другом внутри кластера.
- Устанавливают правила, как поды связываются с внешним миром (например, с интернетом или другими сервисами вне кластера).

### Популярные CNI-плагины и их особенности

#### Calico
- Это как современная сеть дорог с камерами и знаками, где можно настроить строгие правила движения.
- Подходит для сложных кластеров, где важна безопасность и контроль (использует Network Policies для ограничения трафика между подами).
- Использует протокол BGP (Border Gateway Protocol) для маршрутизации.

#### Flannel
- Это как простая грунтовая дорога — лёгкая, быстрая и несложная в настройке.
- Использует overlay-сети (виртуальные сети поверх физических).
- Подходит для небольших или простых кластеров, где не нужны сложные правила безопасности.

#### Cilium
- Это как суперсовременная скоростная трасса с умными датчиками, использующими eBPF (технология ядра Linux для быстрой обработки сетевых пакетов).
- Очень быстрое и мощное решение для больших и высоконагруженных кластеров.
- Обеспечивает не только базовую сеть, но и безопасность, мониторинг и поддержку Network Policies.

### Как выбрать CNI?
- **Flannel** — если кластер маленький и простой.
- **Calico** — если нужна безопасность и контроль доступа.
- **Cilium** — если кластер большой и нагруженный.

## 2. Service Mesh (Istio, Linkerd) — Умное управление трафиком

Service Mesh — это дополнительный слой над сетью Kubernetes, который помогает управлять трафиком между подами (контейнерами).

### Функции Service Mesh:
- **Балансировка нагрузки** — распределяет запросы между подами.
- **Мониторинг** — показывает, сколько запросов проходит, где возникают задержки и ошибки.
- **Безопасность** — шифрует соединения и проверяет, кто с кем может общаться.
- **Автоматизация** — упрощает управление сложными потоками данных.

### Популярные Service Mesh:
#### Istio
- Мощный, но сложный в настройке.
- Использует sidecar-контейнеры для управления трафиком.

#### Linkerd
- Легче и проще, чем Istio.
- Также использует sidecar-контейнеры, но менее требователен к ресурсам.

### Когда использовать Service Mesh?
- Если кластер небольшой, Service Mesh может быть избыточным.
- Если есть сложный трафик и требования к безопасности, Istio или Linkerd помогут его организовать.

## 3. Network Policies — Ограничение доступа между подами

Network Policies в Kubernetes — это "замки" для сетей, которые контролируют, кто с кем может общаться.

### Пример Network Policy
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-telegram-bot-to-postgres
spec:
  podSelector:
    matchLabels:
      app: postgres  # Применяется к подам с меткой app: postgres
  policyTypes:
  - Ingress  # Ограничиваем входящий трафик
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: telegram-bot  # Разрешён только трафик от подов с меткой app: telegram-bot
    ports:
    - protocol: TCP
      port: 5432  # Разрешён доступ только к порту 5432 (PostgreSQL)
```

### Когда использовать Network Policies?
- Если нужно повысить безопасность и ограничить доступ между подами.
- Например, можно запретить auth-service напрямую общаться с postgres, если это не нужно.

## 4. Как это связано с проектом (Telegram-бот для Bitrix24)?

### Рекомендации:
1. **CNI**: Если кластер небольшой, используйте Flannel. Если важна безопасность — Calico.
2. **Service Mesh**: Добавьте Istio или Linkerd, если бот обрабатывает много запросов.
3. **Network Policies**: Настройте доступ только между нужными сервисами.

## 5. Как начать с сетями в Kubernetes

### Установите CNI:
При создании кластера в Yandex MK8S выберите подходящий CNI (например, Flannel для простоты или Calico для безопасности).

### Проверьте сети:
```bash
kubectl get pods -o wide  # Посмотрите IP-адреса подов
kubectl exec -it <под> -- ping <другой_под_IP>  # Проверьте, можно ли пинговать поды
```

### Добавьте Network Policies:
```bash
kubectl apply -f network-policy.yaml
```

### Мониторинг:
Используйте Yandex Monitoring или Prometheus, чтобы следить за сетевым трафиком и нагрузкой.

## 6. Простые аналогии
- **CNI** — это дорожная карта вашего офиса.
- **Service Mesh** — это диспетчер, который следит за движением машин.
- **Network Policies** — это замки и ключи для доступа в помещения.

