# Использование `RETURNING` в PostgreSQL

## Введение

PostgreSQL — это мощная реляционная база данных, которая предоставляет разработчикам гибкие инструменты для работы с данными. Одной из таких особенностей является конструкция `RETURNING`, которая позволяет возвращать данные из строк, затронутых запросами `INSERT`, `UPDATE` или `DELETE`. Это делает запросы более эффективными, так как вы можете получить результат выполнения операции без необходимости делать дополнительный `SELECT`.

В этой лекции мы разберём, что такое `RETURNING`, как оно работает, какие у него возможности, и приведём практические примеры.

---

## Що такое `RETURNING`?

`RETURNING` — это необязательная часть SQL-запросов в PostgreSQL, которая указывает базе данных вернуть определённые данные из строк, которые были вставлены, обновлены или удалены. Она добавляется в конец запроса и работает как встроенный `SELECT`, но без необходимости писать отдельный запрос.

### Синтаксис
Общий синтаксис выглядит так:
```sql
INSERT INTO table_name (column1, column2, ...)
VALUES (value1, value2, ...)
RETURNING column_name1, column_name2, ...;

UPDATE table_name
SET column1 = value1, column2 = value2, ...
WHERE condition
RETURNING column_name1, column_name2, ...;

DELETE FROM table_name
WHERE condition
RETURNING column_name1, column_name2, ...;
```

- `RETURNING` может возвращать конкретные столбцы (например, `RETURNING id, name`), все столбцы (через `RETURNING *`), или даже вычисляемые выражения.
- Результат запроса с `RETURNING` возвращается как таблица, которую можно использовать в приложении или в дальнейших операциях.

---

## Зачем нужен `RETURNING`?

1. **Эффективность**: Вместо выполнения двух запросов (например, `INSERT` и затем `SELECT`), вы можете получить нужные данные за один шаг.
2. **Удобство**: Особенно полезно при вставке данных, когда нужно сразу получить сгенерированные значения (например, автоинкрементные `id`).
3. **Атомарность**: Всё происходит в рамках одной операции, что уменьшает вероятность ошибок из-за параллельных изменений.

---

## Примеры использования

### 1. `RETURNING` с `INSERT`
Представим, что у нас есть таблица `users`:
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    email TEXT UNIQUE
);
```

Мы хотим вставить нового пользователя и сразу получить его `id` и `email`. Используем `RETURNING`:
```sql
INSERT INTO users (name, email)
VALUES ('Иван Иванов', 'ivan@example.com')
RETURNING id, email;
```

**Результат:**
```
 id |        email
----+-------------------
  1 | ivan@example.com
```

- Здесь `id` автоматически сгенерирован благодаря `SERIAL`, и мы сразу получили его значение вместе с `email`.

#### Возвращение всех столбцов
Если нужно получить все данные вставленной строки:
```sql
INSERT INTO users (name, email)
VALUES ('Мария Петрова', 'maria@example.com')
RETURNING *;
```

**Результат:**
```
 id |    name       |        email
----+----------------+-------------------
  2 | Мария Петрова | maria@example.com
```

---

### 2. `RETURNING` с `UPDATE`
Теперь обновим данные пользователя и вернём обновлённые значения. Например, изменим email:
```sql
UPDATE users
SET email = 'ivan_new@example.com'
WHERE name = 'Иван Иванов'
RETURNING id, name, email;
```

**Результат:**
```
 id |    name     |        email
----+-------------+---------------------
  1 | Иван Иванов | ivan_new@example.com
```

- Мы видим, что строка обновилась, и сразу получили её новые значения.

#### Использование вычисляемых выражений
`RETURNING` позволяет возвращать не только столбцы, но и вычисляемые значения:
```sql
UPDATE users
SET name = UPPER(name)
WHERE id = 1
RETURNING id, name, LENGTH(name) AS name_length;
```

**Результат:**
```
 id |    name     | name_length
----+-------------+-------------
  1 | ИВАН ИВАНОВ | 11
```

- Здесь `UPPER(name)` преобразовал имя в верхний регистр, а `LENGTH(name)` посчитал длину строки.

---

### 3. `RETURNING` с `DELETE`
Удалим пользователя и вернём информацию о том, что было удалено:
```sql
DELETE FROM users
WHERE id = 2
RETURNING *;
```

**Результат:**
```
 id |    name       |        email
----+----------------+-------------------
  2 | Мария Петрова | maria@example.com
```

- Мы удалили строку и сразу получили её данные, что полезно для логирования или проверки.

---

## Расширенные возможности

### Использование в CTE (Common Table Expressions)
`RETURNING` можно комбинировать с `WITH` для выполнения сложных операций. Например:
```sql
WITH deleted AS (
    DELETE FROM users
    WHERE email LIKE '%example.com'
    RETURNING id, name
)
SELECT * FROM deleted;
```

- Здесь мы удалили всех пользователей с доменом `example.com` и вернули их `id` и `name` через CTE.

### Вставка с конфликтом (`ON CONFLICT`)
При использовании `INSERT ... ON CONFLICT` конструкция `RETURNING` тоже работает:
```sql
INSERT INTO users (name, email)
VALUES ('Иван Иванов', 'ivan@example.com')
ON CONFLICT (email) DO UPDATE
SET name = EXCLUDED.name
RETURNING id, email;
```

- Если email уже существует, произойдёт обновление, и мы получим результат.

---

## Ограничения и особенности

1. **Только изменённые строки**: `RETURNING` возвращает только те строки, которые реально были затронуты запросом. Если условие `WHERE` в `UPDATE` или `DELETE` не нашло строк, результат будет пустым.
2. **Совместимость**: `RETURNING` — это фича PostgreSQL, её нет в некоторых других СУБД (например, MySQL до версии 8.0.19 не поддерживает аналог).
3. **Производительность**: Использование `RETURNING` не добавляет значительных накладных расходов, так как данные уже доступны в процессе выполнения запроса.

---

## Практическое применение

1. **Получение ID после вставки**: Вместо `INSERT` с последующим `SELECT`, используйте `RETURNING id`.
2. **Логирование изменений**: Сохраняйте данные, возвращённые `RETURNING`, в таблицу логов.
3. **Обновление связанных данных**: Используйте `RETURNING` в CTE для передачи данных в следующую операцию.

---

## Заключение

Конструкция `RETURNING` в PostgreSQL — это мощный и удобный инструмент, который упрощает работу с данными и повышает эффективность запросов. Она позволяет сократить количество операций, получать результаты сразу и гибко обрабатывать изменения в таблицах. Освоив `RETURNING`, вы сможете писать более лаконичный и производительный код.